!function(o,t){"use strict";var s=function(){this.hook=null,this.output=[],this.offset=-1,this.sanitize=[],this.isPromise=!0},e=/[&<>'\"]/g;s.sanitize=function(t){return"string"!=typeof t&&(t=t.toString()),t.replace(e,function(t){return"&"==t?"&amp;":"<"==t?"&lt;":">"==t?"&gt;":'"'==t?"&#34;":"'"==t?"&#39;":t})},s.prototype.buffer=function(t){var e=this.hook,i=this.output,n=this.offset,o=this.sanitize,s=this.isPromise;return this.hook=null,this.output=[],this.offset=-1,this.sanitize=[],this.isPromise=!0,function(){var t=this.toString();return this.hook=e,this.output=i,this.offset=n,this.sanitize=o,this.isPromise=s,t}.bind(this)},s.prototype.write=function(t){if(null!=t){var e="string"==typeof t;e||"function"==typeof t.then||(t=t.toString(),e=!0),e?this.isPromise?(this.output.push(t),this.isPromise=!1,this.offset++):this.output[this.offset]+=t:(this.isPromise=!0,this.offset++,this.output.push(t))}},s.prototype.safe_write=function(t){if(null!=t){var e="string"==typeof t;e||"function"==typeof t.then||(t=t.toString(),e=!0),e?this.isPromise?(this.output.push(s.sanitize(t)),this.isPromise=!1,this.offset++):this.output[this.offset]+=s.sanitize(t):(this.isPromise=!0,this.offset++,this.sanitize.push(this.offset),this.output.push(t))}},s.prototype.toString=function(){var t;if(t=-1==this.offset?"":0==this.offset?this.output[0]:Promise.all(this.output).then(function(t){for(var e=0,i=this.sanitize.length;e<i;e++){var n=this.sanitize[e];t[n]=s.sanitize(null==t[n]?"":t[n])}return t.join("")}.bind(this)),this.hook){if(t.then)return t.then(function(t){return this.hook(t)}.bind(this));t=this.hook(t)}return t};var u=function(t){t||(t={}),this.options={cache:t.cache||!1,strict:t.strict||!1,localsName:t.localsName||"locals",root:t.root||"/"},this._session={}};u.__cache={},u.__fn={},u.prototype.compile=function(t,e){if(this.options.cache&&u.__cache.hasOwnProperty(t))return u.__cache[t];var i=new lexer;i.input(t);var n=new transpile(i,this.options,e||"eval").toString();try{var o=new Function("ejs,"+this.options.localsName,n).bind(null,this);return this.options.cache&&(u.__cache[t]=o),o}catch(t){var s=t.lineNumber?t.lineNumber-6:1,r=new SyntaxError(t.message,e,s);throw r.stack=t.message+"\n    at "+e+":"+s+"\n"+r.stack.split(/\n/g).slice(4).join("\n"),r}},u.compile=function(t,e){return new u(e).compile(t)},u.prototype.render=function(t,e){var i=this.compile(t)(e);return"function"==typeof i.then?i:Promise.resolve(i)},u.prototype.output=function(){return new s},u.render=function(t,e,i){return new u(i).render(t,e)},u.prototype.include=function(t,e,i,n){return"function"==typeof n&&(n={contents:n()}),"string"==typeof n&&(n={contents:n}),this.renderFile(this.resolveInclude(i,e),Object.assign({},t,n||{}))},u.prototype.layout=function(e,i,t,n,o){var s=this;return t.hook=function(t){return(o=Object.assign({},e,o||{})).contents=t,s.renderFile(s.resolveInclude(n,i),o)},null},u.prototype.block=function(t,e,i){if(!e)return null;if(this._session[e]||(this._session[e]=this.output()),3!=arguments.length)return this._session[e].toString();if("function"==typeof i){var n=this._output.buffer();i(),i=n()}return this._session[e].write(i),this._session[e]},u.prototype.resolveInclude=function(t,e,i){return e&&"eval"!=e||(e=this.options.root,i=!0),"/"==t[0]&&(t="./"+t.replace(/^\/*/,""),e=this.options.root,i=!0),u.resolveInclude(t,e,i)},u.resolveInclude=function(t,e,i){return e&&(i||(e=path.dirname(e)),t=path.resolve(e,t)),path.extname(t)||(t+=".ejs"),t},u.registerFunction=function(t,e){u.__fn[t]=e,transpile.__fn[t]=!0},u.prototype.renderFile=function(s,r){var h=this;return new Promise(function(i,n){s.substring(0,h.options.root.length)!=h.options.root&&(s=u.resolveInclude(s,h.options.root,!0));var o=function(t){try{var e=h.compile(t.toString(),s)(r);e&&"function"==typeof e.then?e.then(i).catch(n):i(e)}catch(t){return n(t)}};h.options.cache&&u.__cache.hasOwnProperty(s)?o(u.__cache[s]):fs.readFile(s,function(t,e){if(t)return n(t);h.options.cache&&(u.__cache[s]=e),o(e)})})},u.renderFile=function(t,e,i){return new u(i).renderFile(t,e)},u.__express=function(t,e,i){var n={};e.settings&&(e.settings["view cache"]&&(n.cache=!0),e.settings.views&&(n.root=e.settings.views)),u.renderFile(t,e,n).then(function(t){if(!i||"function"!=typeof i)throw new Error("No response callback");i(null,t)}).catch(function(t){if(!i||"function"!=typeof i)throw t;i(t,null)})},"undefined"!=typeof window?window.ejs=u:"undefined"!=typeof global&&(global.ejs=u),t&&(t.ejs=u),"function"==typeof define&&define.amd&&define("ejs",u),o&&o.fn&&(o.fn.extend({ejs:function(e,t){var i=o.fn.ejs.options;t&&(i=o.extend(!0,i,t));var n=new n(i);return this.each(function(){var t=o(this).html();n.compile(t)(e).then(function(t){o(this).html(t)}.bind(this)).catch(function(t){o(this).html('<pre class="ejs-error">'+t.toString()+"</pre>")})})}}),o.fn.ejs.options={})}(jQuery,window);